
# Region Flexibility for GCE Instance Testing

## Intro
When GCE introduces new instance types or new features on existing instance
types these are generally not immediately available in all regions. Examples
include confidential compute features.
Therefore it is necessary to support a flexible test approach that allows mash
to run the specified tests with configured instance types in a specific region.

Supporting the configuration of specific instance types to test in specified
regions provides the required felxibility.

## Overview

GCE replicates created images to all regions. Therefore, mash does not 
need to perform any special tasks w.r.t. to image creation in the
configured test regions.

Below a configuration example specifying instance types to be used for
testing.

## Configuring the Test Instances

```
cloud:
  gce:
    test_instance_catalog:
    - region: us-east1-c
      test_fallback_regions:
      - us-east1-b
      - us-east4-a
      arch: X86_64
      instance_types:
      - n1-standard-1
      - n1-highmem-2
      - n1-highcpu-2
      boot_types:
        - uefi
      shielded_vm:
        - securevm_enabled
      nic:
        - gvnic_enabled
      confidential_compute: []
    - region: us-central1-a
      test_fallback_regions:
      - us-central1-b
      - us-east1-b
      arch: X86_64
      instance_types:
      - n2d-standard-2
      boot_types:
        - uefi
      shielded_vm:
        - securevm_enabled
      nic:
        - gvnic_enabled
      confidential_compute:
        - AmdSevSnp_enabled
        - AmdSev_enabled
    - region: us-east1-d
      test_fallback_regions:
      - us-east1-b
      - us-east1-c
      arch: X86_64
      instance_types:
      - c4d-standard-4
      - c3d-standard-4
      boot_types:
        - uefi
      shielded_vm:
        - securevm_enabled
      nic:
        - gvnic_enabled
      confidential_compute:
        - AmdSev_enabled
```

The `test_instance_catalog` key is the beginning of the section that supports
association of instance types to specific regions as well as specific
features to be configured when the test instance is launched.

Test scenarios are generated by creating combinations of the the supported
 features in the image and the instance types in the test catalog. To prevent a
 combinatorial explosion of test cases, some limitations are included as 
 follows:
- Only one test is run with `gvnic` feature disabled.
- Only one test is run with `securevm` feature disabled.

If the instance types in the catalog do not support the full test matrix,
unsupported combinations will be skipped and the information is logged.
If the configured test combination is the primary test case and cannot
be tested no tests are executed and an error is generated.
For example configuring BIOS boot with AMD SEV would trigger such an error.
The use of AMD SEC requires UEFI secure boot.

Note that instances for different architectures have to be added to the
config file if you plan to publish images for different architectures.

The following settings are required for each instance group:
 - *region*: the test region to be used if one of these instances is
 selected.
 - *test_fallback_regions*: Additional GCE regions that can be used in case
 an error is found in the GCE platform when attempting the tests in the
 specified region.
 - *arch*: instance architecture (x86_64 or aarch64)
 - *instance_types*: list of the instance types. One of these will be selected
 randomly.
 - *boot_types*: which boot types do these instance types support
 (bios/uefi).
 - *shielded_vm*: instance type supports the GCE shielded_vm feature.
 - *nic*: instance type supports gvnic feature.
 - *confidential_compute*: Instance features that are supported.
  `AmdSev_enabled` is the value required for AMD's Sev feature.


## Instance feature tests

In addition to associating specific instance types with specific features
in designated regions it is also necessary to execute feature specific tests.
This is accomplished by using the `instance_feature_additional_tests`
configuration setting as shown in the example configuration snippet below:

```
cloud:
  gce:
  ...
    instance_feature_additional_tests:
      AmdSev_enabled:
        - test_sles_sev
```

With the above configuration any image that is tested on an instance type that
has `AmdSev_enabled` set will be tested with the tests configured in the
job doc and additionally the `test_sles_sev` will get executed.

mash uses img-proof as the test framework and as such the named test must be
available in the img-proof search tree.

## GCE account

NO additional account parameters are required to use this feature
